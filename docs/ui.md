# kojo - UI Design

## 画面構成

モバイルファーストの Web UI。4 つの主要画面。

```
┌─────────────────────────────┐
│  Dashboard (セッション一覧)   │ ← ホーム画面
├─────────────────────────────┤
│  Terminal (ターミナル表示)    │ ← セッション選択後
├─────────────────────────────┤
│  New Session (新規作成)      │ ← FAB / ヘッダーボタンから
├─────────────────────────────┤
│  File Browser (ファイル閲覧)  │ ← Dashboard / Terminal から
├─────────────────────────────┤
│  Git Panel (Git 操作)        │ ← File Browser から
└─────────────────────────────┘
```

---

## 1. Dashboard

セッション一覧。kojo を開いたときの最初の画面。

```
┌─────────────────────────────────┐
│  kojo                    [+ New]│
├─────────────────────────────────┤
│                                 │
│  ┌─ claude ──────────────────┐  │
│  │  ~/GitHub/kojo            │  │
│  │  ● running    2 min ago   │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌─ codex ───────────────────┐  │
│  │  ~/GitHub/myapp           │  │
│  │  ● running    5 min ago   │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌─ claude ──────────────────┐  │
│  │  ~/GitHub/api             │  │
│  │  ○ exited (0)  1 hr ago   │  │
│  └───────────────────────────┘  │
│                                 │
└─────────────────────────────────┘
```

- セッションカードをタップ → Terminal 画面へ
- running セッションが上、exited が下
- ステータスインジケーター: `●` running (緑), `○` exited (灰)
- スワイプで停止/削除

---

## 2. Terminal

xterm.js によるフルスクリーンターミナル。

```
┌─────────────────────────────────┐
│  ← claude  ~/GitHub/kojo [⚡][■]│
├─────────────────────────────────┤
│                                 │
│  $ claude                       │
│                                 │
│  I'll help you with that.       │
│  Let me read the file first.    │
│                                 │
│  ╭──────────────────────────╮   │
│  │ Do you want to allow     │   │
│  │ editing src/main.go?     │   │
│  ╰──────────────────────────╯   │
│                                 │
│  ┌───────────────────────────┐  │
│  │  [Allow]  [Deny]  [Skip] │  │  ← クイックアクション
│  └───────────────────────────┘  │
│                                 │
├─────────────────────────────────┤
│ [Esc][Tab][Ctrl][↑][↓][←][→]  │  ← 補助キーバー
├─────────────────────────────────┤
│  [📎][input field        ][Send]│
└─────────────────────────────────┘
```

- ヘッダー: 戻るボタン、ツール名、作業ディレクトリ、yolo トグル `[⚡]`、停止ボタン `[■]`
- ターミナル領域: xterm.js（スクロール、選択、コピー対応）
- クイックアクション: permission prompt 検出時に表示されるボタン群（後述）
- 補助キーバー: ソフトキーボード上部に常駐する特殊キーツールバー（後述）
- 入力欄: テキスト入力 + 送信ボタン
- 入力欄はソフトキーボードに追従してリサイズ

### 補助キーバー

モバイルのソフトキーボードでは入力できない特殊キーを補助するツールバー。入力欄の上に常時表示。

```
┌─────────────────────────────────────────┐
│ [Esc] [Tab] [Ctrl] [↑] [↓] [←] [→]   │
└─────────────────────────────────────────┘
```

- **Esc**: `\x1b` を PTY に送信
- **Tab**: `\t` を送信。補完操作用
- **Ctrl**: トグルボタン。ON の状態で他のキーを打つと Ctrl+X として送信。例: Ctrl ON → `c` → `Ctrl+C` (`\x03`) を送信
- **矢印キー**: ANSI エスケープシーケンスを送信。コマンド履歴やカーソル移動用

横スクロールで追加キーも配置可能（`|`, `/`, `~` 等）。

### クイックアクション

PTY 出力をパターンマッチングし、ユーザーの応答が必要な場面を検出してボタンを表示する。

**検出パターンと表示ボタン:**

| パターン | ボタン |
|---------|--------|
| `(y/n)`, `[Y/n]`, `[y/N]` | `[Yes]` `[No]` |
| `Allow`, `Deny` (Claude Code permission) | `[Allow]` `[Deny]` |
| `(1-N)` 番号選択 | `[1]` `[2]` `[3]` ... |

- ボタンタップで対応する文字列 + Enter を PTY に送信
- prompt が解消されたら（次の出力が来たら）ボタンを非表示に
- あくまで補助。表示されなくても入力欄から手動入力は常に可能

### Yolo モード

ヘッダーの `[⚡]` ボタンでセッション単位で ON/OFF を切り替え。

- **OFF (デフォルト)**: 全ての prompt でクイックアクション表示 + Web Push 通知
- **ON**: permission 系 prompt を自動承認。質問系 prompt のみクイックアクション表示 + 通知

Yolo ON の状態で自動承認が発生すると、ターミナル上には通常通り出力が流れる（PTY にそのまま書き込むため）。加えて WebSocket 経由で `yolo_auto_approved` メッセージが届き、クライアントは小さなトースト通知で「Auto-approved: (y/n)」のように表示する。

```
┌──────────────────────────────┐
│ ⚡ Auto-approved: Allow edit │  ← トースト（数秒で消える）
└──────────────────────────────┘
```

Yolo モード中でもクイックアクションが表示される場合（質問系）は、通常と同じく Web Push 通知も送信。モバイルから離れていても気づける。

### ファイル添付

入力欄の `[📎]` ボタンからモバイルデバイスのファイルを添付できる。

**対応ソース:**
- カメラ撮影（iOS/Android）
- 写真ライブラリ
- ファイルアプリ（テキスト、画像等）

**フロー:**
1. `[📎]` タップ → OS のファイルピッカー / カメラを起動
2. ファイル選択 → `POST /api/v1/upload` で macOS にアップロード
3. 返されたパスを入力欄に自動挿入（例: `/tmp/kojo/upload/img_001.png`）
4. ユーザーがプロンプトを書いて送信

```
┌─────────────────────────────────┐
│  [📎] この画像のバグを直して     │
│  /tmp/kojo/upload/img_001.png   │
│                          [Send] │
└─────────────────────────────────┘
```

- 複数ファイルの添付も可能（パスが改行区切りで挿入される）
- アップロード中はプログレスインジケーターを表示
- AI CLI がパスを認識してファイルを読み取る（Claude Code は画像パス対応）

### ターミナル操作

- **入力**: 入力欄にテキストを打って Send、または Enter で送信。改行付きで PTY に書き込み
- **リサイズ**: 画面サイズ変更時に xterm.js の fit addon が自動計算し、resize メッセージを送信
- **スクロールバック**: WebSocket 接続時に scrollback メッセージで直近の出力を受信。途中から見ても文脈がわかる
- **再接続**: WebSocket 切断時は exponential backoff で自動再接続。再接続中は画面上部に「Reconnecting...」インジケーターを表示。再接続成功時に scrollback で表示を復元

---

## 3. New Session

新規セッション作成ダイアログ。

```
┌─────────────────────────────────┐
│  New Session               [×] │
├─────────────────────────────────┤
│                                 │
│  Tool                           │
│  ┌───────────────────────────┐  │
│  │ ○ claude                  │  │
│  │ ○ codex                   │  │
│  │ ○ gemini  (not available) │  │
│  └───────────────────────────┘  │
│                                 │
│  Working Directory              │
│  ┌───────────────────────────┐  │
│  │ ~/GitHub/kojo        [📁] │  │
│  └───────────────────────────┘  │
│                                 │
│  Additional Arguments           │
│  ┌───────────────────────────┐  │
│  │ --model opus              │  │
│  └───────────────────────────┘  │
│                                 │
│  [⚡ Yolo Mode          OFF]   │
│                                 │
│           [Start Session]       │
│                                 │
└─────────────────────────────────┘
```

- ツール選択: 利用可能なツールのみ選択可（`GET /api/v1/info` で判定）
- 作業ディレクトリ: パス表示 + ブラウズボタン → File Browser へ
- 追加引数: 自由入力（省略可）
- Start Session → `POST /api/v1/sessions` → Terminal 画面へ遷移

---

## 4. File Browser

2 つのモードで使用: ディレクトリ選択（New Session 内）と、ファイル閲覧（独立画面）。

### ディレクトリ選択モード

New Session のディレクトリ選択時に使用。ディレクトリのみ表示。

```
┌─────────────────────────────────┐
│  ← Select Directory             │
├─────────────────────────────────┤
│  /Users/you/GitHub            │
├─────────────────────────────────┤
│  📁 ..                          │
│  📁 kojo                        │
│  📁 happy                       │
│  📁 myapp                       │
│  📁 dotfiles                    │
│                                 │
├─────────────────────────────────┤
│      [Select This Directory]    │
└─────────────────────────────────┘
```

### 閲覧モード

Dashboard からアクセスできる独立画面。ファイルとディレクトリの両方を表示。

```
┌─────────────────────────────────┐
│  ← Files  ~/GitHub/kojo    [git]│
├─────────────────────────────────┤
│  📁 ..                          │
│  📁 cmd                         │
│  📁 internal                    │
│  📁 web                         │
│  📄 main.go                     │
│  📄 go.mod                      │
│  📄 README.md                   │
│  🖼 screenshot.png              │
│                                 │
└─────────────────────────────────┘
```

- ディレクトリタップ → 中に入る
- テキストファイルタップ → ファイルビューア（後述）
- 画像ファイルタップ → 画像ビューア（後述）
- `[git]` ボタン → Git パネル（後述）
- ヘッダーのパスタップ → パス直接入力

### ファイルビューア

テキストファイルの読み取り専用表示。シンタックスハイライト付き。

```
┌─────────────────────────────────┐
│  ← main.go                     │
├─────────────────────────────────┤
│  1  package main                │
│  2                              │
│  3  import (                    │
│  4      "fmt"                   │
│  5      "net/http"              │
│  6  )                           │
│  7                              │
│  8  func main() {              │
│  9      fmt.Println("kojo")    │
│ 10  }                           │
│                                 │
└─────────────────────────────────┘
```

- 行番号表示
- シンタックスハイライト（言語はファイル拡張子から自動判定）
- スクロール・テキスト選択・コピー対応
- 読み取り専用（編集不可）

### 画像ビューア

画像ファイルの表示。ピンチズーム対応。

```
┌─────────────────────────────────┐
│  ← screenshot.png               │
├─────────────────────────────────┤
│                                 │
│    ┌───────────────────────┐    │
│    │                       │    │
│    │      (画像表示)        │    │
│    │                       │    │
│    └───────────────────────┘    │
│                                 │
│    204 KB · 1920×1080 · PNG     │
│                                 │
└─────────────────────────────────┘
```

---

## 5. Git パネル

File Browser のヘッダー `[git]` からアクセス。現在のディレクトリの Git 状態を表示・操作。

```
┌─────────────────────────────────┐
│  ← Git  ~/GitHub/kojo           │
├─────────────────────────────────┤
│  branch: main  ↑2 ↓0           │
├─────────────────────────────────┤
│  Staged                         │
│    ✚ src/main.go                │
│                                 │
│  Modified                       │
│    ✎ README.md                  │
│                                 │
│  Untracked                      │
│    ? tmp/debug.log              │
│                                 │
├─────────────────────────────────┤
│  Recent Commits                 │
│  abc1234 fix: resolve login bug │
│  def5678 feat: add upload API   │
│  ghi9012 docs: update README    │
│                                 │
├─────────────────────────────────┤
│  [Diff] [Log] [Run git...]     │
└─────────────────────────────────┘
```

- **ステータス表示**: ブランチ名、ahead/behind、staged/modified/untracked ファイル一覧
- **ファイルタップ**: diff を表示
- **Diff ボタン**: unstaged/staged の全体 diff を表示
- **Log ボタン**: コミットログ一覧表示
- **Run git... ボタン**: 任意の git コマンドを実行するダイアログ

### Git コマンド実行

```
┌─────────────────────────────────┐
│  Run Git Command           [×] │
├─────────────────────────────────┤
│                                 │
│  git [                        ] │
│                                 │
│  Quick:                         │
│  [add .] [commit] [pull] [push] │
│                                 │
│              [Run]              │
│                                 │
├─────────────────────────────────┤
│  $ git add .                    │
│  (exit 0)                       │
│                                 │
└─────────────────────────────────┘
```

- `git` プレフィックスは固定。サブコマンド以降を入力
- クイックボタンで頻出コマンドをワンタップ実行
- 実行結果（stdout/stderr + exit code）をダイアログ下部に表示
- 破壊的操作（`push --force`, `reset --hard`）は実行前に確認ダイアログを表示

---

## テーマ

- ダークテーマ（ターミナルとの親和性）
- カラーパレット: ターミナル標準色ベース
- フォント: monospace（ターミナル部分）、system-ui（UI 部分）

## レスポンシブ

- モバイル (< 768px): 上記レイアウト
- タブレット・デスクトップ (>= 768px): サイドバーにセッション一覧、メインにターミナル

```
Desktop Layout:
┌──────────┬──────────────────────────────┐
│ Sessions │  Terminal                     │
│          │                              │
│ ● claude │  $ claude                    │
│ ● codex  │                              │
│ ○ claude │  I'll help you...            │
│          │                              │
│          │                              │
│ [+ New]  │  [input field         ][Send]│
└──────────┴──────────────────────────────┘
```

---

## 通知 UX

### サブスクリプション

初回アクセス時に Web Push の許可を求める。ブラウザの Permission API を使用。

### 通知表示

```
┌─────────────────────────────────┐
│ 🔔 Claude Code                  │
│ Permission Required             │
│ Do you want to allow editing... │
└─────────────────────────────────┘
```

通知タップ → kojo Web UI の該当セッション Terminal 画面を開く。

### Service Worker

Web Push 受信と通知表示のために Service Worker を登録。オフラインキャッシュは不要（Tailscale 接続が前提）。
